import React, { useEffect, useState } from 'react';
import { View, Text, StyleSheet, Image, TouchableOpacity, TextInput, Alert, Platform, ScrollView } from 'react-native';
import { scale } from './utils/scale';
import * as ImagePicker from 'expo-image-picker';
import { SafeAreaView as RNSSafeAreaView } from 'react-native-safe-area-context/lib/commonjs/SafeAreaView';

interface Patient {
  user_id?: number;
  dob?: string;
  gender?: string;
  phone?: string;
  blood_group?: string;
  allergies?: string[];
  chronic_conditions?: string[];
  current_medications?: string[];
  emergency_contact_name?: string;
  address?: string;
  image_path?: string;
}

export default function Profile({ name, email, avatarUri, userId, onBack, onLogout, patient, onSave }:
  { name?: string; email?: string; avatarUri?: string; userId?: number; onBack?: () => void; onLogout?: () => void; patient?: Patient; onSave?: (p: Patient|undefined)=>void }) {
  const displayName = name || (email ? email.split('@')[0] : 'User');
  const [editing, setEditing] = useState(false);
  const [localPatient, setLocalPatient] = useState<Patient | undefined>(patient);
  const [localAvatar, setLocalAvatar] = useState<string|undefined>(avatarUri);

  useEffect(() => setLocalPatient(patient), [patient]);
  useEffect(() => setLocalAvatar(avatarUri), [avatarUri]);

  const arrayToString = (arr?: string[]) => (arr && arr.length ? arr.join(', ') : '');
  const stringToArray = (s?: string) => (s ? s.split(',').map(i => i.trim()).filter(Boolean) : []);

  function startEdit() { setLocalPatient(patient ? { ...patient } : {}); setEditing(true); }
  function cancelEdit() { setLocalPatient(patient); setEditing(false); }
  function saveEdit() { if (onSave) onSave(localPatient); setEditing(false); }

  async function fetchPreview(userId?: number) {
    if (userId === undefined) return;
    const endpoint = `https://clinic-backend-s2lx.onrender.com/api/auth/profile-image/preview?user_id=${userId}`;
    try {
      const resp = await fetch(endpoint, { method: 'GET', headers: { accept: 'application/json' } });
      const json = await resp.json();
      if (resp.ok && json?.preview_url) {
        setLocalAvatar(json.preview_url);
      } else {
        console.warn('preview fetch failed', resp.status, json);
      }
    } catch (err) {
      console.warn('fetchPreview error', err);
    }
  }

  useEffect(() => {
    const uid = userId ?? patient?.user_id;
    if (uid !== undefined) fetchPreview(uid);
  }, [userId, patient?.user_id]);

  async function uploadProfileImage(uri?: string, name?: string, type?: string) {
    if (!uri) return;
    const uid = userId ?? localPatient?.user_id;
    if (uid === undefined) {
      console.warn('No user id provided for image upload');
      Alert.alert('Upload failed', 'No user id provided');
      return;
    }

    // Normalize uri for Android content URIs if needed
    let fileUri = uri;
    if (Platform.OS === 'android' && !fileUri.startsWith('file://') && fileUri.startsWith('/')) {
      fileUri = 'file://' + fileUri;
    }

    const form = new FormData();
    form.append('user_id', String(uid));
    form.append('image', { uri: fileUri, name: name || 'photo.jpg', type: type || 'image/jpeg' } as any);

    try {
      const resp = await fetch('https://clinic-backend-s2lx.onrender.com/api/auth/profile-image', {
        method: 'POST',
        body: form,
      });
      const json = await resp.json();
      if (resp.ok && json?.profile?.image_path) {
        // ask the backend for a signed preview URL and set that as avatar
        const uid = userId ?? localPatient?.user_id;
        setLocalPatient(p => ({ ...(p||{}), image_path: json.profile.image_path }));
        if (uid !== undefined) await fetchPreview(uid);
        Alert.alert('Success', json.message || 'Profile image saved');
      } else {
        console.warn('upload failed', resp.status, json);
        Alert.alert('Upload failed', json?.message || `Server returned ${resp.status}`);
      }
    } catch (err) {
      console.warn('uploadProfileImage error', err);
      Alert.alert('Upload error', String(err));
    }
  }

  async function pickImageAndUpload() {
    const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (status !== 'granted') {
      Alert.alert('Permissions required', 'Permission to access the photo library is required.');
      return;
    }

    try {
      const res = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        quality: 0.8,
        allowsEditing: false,
      });
      // Old API returned { cancelled, uri }, newer returns { cancelled, assets: [{ uri }] }
      const cancelled = (res as any).cancelled === true;
      if (cancelled) return;
      const uri = (res as any).assets?.[0]?.uri || (res as any).uri;
      if (!uri) return;
      setLocalAvatar(uri);
      const name = uri.split('/').pop() || 'photo.jpg';
      uploadProfileImage(uri, name, 'image/jpeg');
    } catch (err) {
      console.warn('ImagePicker error', err);
    }
  }

  return (
    <RNSSafeAreaView style={styles.safe}>
      <View style={styles.header}>
        <TouchableOpacity onPress={() => onBack && onBack()} style={styles.backBtn}>
          <Text style={styles.backIcon}>‚Üê</Text>
          <Text style={styles.backText}>Back</Text>
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Profile</Text>
        <View style={styles.headerSpacer} />
      </View>

      <ScrollView style={styles.container} contentContainerStyle={{ paddingBottom: 40 }}>
        <View style={styles.profileCard}>
          <Image source={{ uri: localAvatar || avatarUri || `https://i.pravatar.cc/150?u=${encodeURIComponent(email||'anon')}` }} style={styles.avatar} />
          <TouchableOpacity style={styles.changeAvatar} onPress={pickImageAndUpload}>
            <Text style={styles.changeAvatarText}>Change Avatar</Text>
          </TouchableOpacity>
          <Text style={styles.name}>{displayName}</Text>
          <Text style={styles.email}>{email || 'No email'}</Text>
          <View style={styles.statusContainer}>
            <View style={styles.statusDot} />
            <Text style={styles.statusText}>Available</Text>
          </View>
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Personal Information</Text>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Date of Birth</Text>
            {editing ? (
              <TextInput style={styles.input} value={localPatient?.dob || ''} onChangeText={t => setLocalPatient({ ...(localPatient||{}), dob: t })} placeholder="YYYY-MM-DD" />
            ) : (
              <Text style={styles.infoValue}>{patient?.dob ? new Date(patient.dob).toLocaleDateString() : 'Not set'}</Text>
            )}
          </View>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Blood Type</Text>
            {editing ? (
              <TextInput style={styles.input} value={localPatient?.blood_group || ''} onChangeText={t => setLocalPatient({ ...(localPatient||{}), blood_group: t })} />
            ) : (
              <Text style={styles.infoValue}>{patient?.blood_group || 'Not set'}</Text>
            )}
          </View>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Emergency Contact</Text>
            {editing ? (
              <TextInput style={styles.input} value={localPatient?.emergency_contact_name || ''} onChangeText={t => setLocalPatient({ ...(localPatient||{}), emergency_contact_name: t })} />
            ) : (
              <Text style={styles.infoValue}>{patient?.emergency_contact_name || 'Not set'}</Text>
            )}
          </View>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Phone</Text>
            {editing ? (
              <TextInput style={styles.input} value={localPatient?.phone || ''} onChangeText={t => setLocalPatient({ ...(localPatient||{}), phone: t })} />
            ) : (
              <Text style={styles.infoValue}>{patient?.phone || 'Not set'}</Text>
            )}
          </View>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Address</Text>
            {editing ? (
              <TextInput style={styles.input} value={localPatient?.address || ''} onChangeText={t => setLocalPatient({ ...(localPatient||{}), address: t })} />
            ) : (
              <Text style={styles.infoValue}>{patient?.address || 'Not set'}</Text>
            )}
          </View>
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Health Information</Text>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Allergies</Text>
            {editing ? (
              <TextInput style={styles.input} value={arrayToString(localPatient?.allergies)} onChangeText={t => setLocalPatient({ ...(localPatient||{}), allergies: stringToArray(t) })} placeholder="comma separated" />
            ) : (
              <Text style={styles.infoValue}>{(patient?.allergies && patient.allergies.length) ? patient.allergies.join(', ') : 'None'}</Text>
            )}
          </View>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Chronic Conditions</Text>
            {editing ? (
              <TextInput style={styles.input} value={arrayToString(localPatient?.chronic_conditions)} onChangeText={t => setLocalPatient({ ...(localPatient||{}), chronic_conditions: stringToArray(t) })} placeholder="comma separated" />
            ) : (
              <Text style={styles.infoValue}>{(patient?.chronic_conditions && patient.chronic_conditions.length) ? patient.chronic_conditions.join(', ') : 'None'}</Text>
            )}
          </View>
          <View style={styles.infoRow}>
            <Text style={styles.infoLabel}>Current Medications</Text>
            {editing ? (
              <TextInput style={styles.input} value={arrayToString(localPatient?.current_medications)} onChangeText={t => setLocalPatient({ ...(localPatient||{}), current_medications: stringToArray(t) })} placeholder="comma separated" />
            ) : (
              <Text style={styles.infoValue}>{(patient?.current_medications && patient.current_medications.length) ? patient.current_medications.join(', ') : 'None'}</Text>
            )}
          </View>
        </View>

        {!editing ? (
          <TouchableOpacity style={styles.editButton} onPress={startEdit}>
            <Text style={styles.editButtonText}>Edit Profile</Text>
          </TouchableOpacity>
        ) : (
          <View style={{ flexDirection: 'row', justifyContent: 'space-between' }}>
            <TouchableOpacity style={styles.editButton} onPress={saveEdit}>
              <Text style={styles.editButtonText}>Save</Text>
            </TouchableOpacity>
            <TouchableOpacity style={styles.cancelButton} onPress={cancelEdit}>
              <Text style={styles.cancelButtonText}>Cancel</Text>
            </TouchableOpacity>
          </View>
        )}

        <TouchableOpacity style={styles.logout} onPress={() => onLogout && onLogout()}>
          <Text style={styles.logoutText}>Sign out</Text>
        </TouchableOpacity>
      </ScrollView>
    </RNSSafeAreaView>
  );
}

const styles = StyleSheet.create({
  safe: { 
    flex: 1, 
    backgroundColor: '#F0F9FF' 
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingVertical: 12,
    backgroundColor: '#FFFFFF',
    borderBottomWidth: 1,
    borderBottomColor: '#E2E8F0',
  },
  backBtn: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: 8,
    paddingHorizontal: 4,
  },
  backIcon: {
    fontSize: scale(16),
    color: '#0b3d91',
    marginRight: scale(4),
    fontWeight: '600',
  },
  backText: {
    color: '#0b3d91',
    fontSize: scale(14),
    fontWeight: '600',
  },
  headerTitle: {
    fontSize: scale(16),
    fontWeight: '700',
    color: '#1E293B',
  },
  headerSpacer: {
    width: scale(56), // Balance the back button
  },
  container: {
    flex: 1,
    padding: scale(12),
  },
  profileCard: {
    backgroundColor: '#FFFFFF',
    borderRadius: scale(16),
    padding: scale(18),
    alignItems: 'center',
    marginBottom: 20,
    shadowColor: '#1E293B',
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.1,
    shadowRadius: 16,
    elevation: 8,
  },
  avatar: {
    width: scale(80),
    height: scale(80),
    borderRadius: scale(40),
    marginBottom: scale(12),
    backgroundColor: '#E5E7EB',
    borderWidth: scale(4),
    borderColor: '#FFFFFF',
    shadowColor: '#0b3d91',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.2,
    shadowRadius: 8,
    elevation: 4,
  },
  name: {
    fontSize: scale(20),
    fontWeight: '700',
    color: '#1E293B',
    marginBottom: scale(4),
  },
  email: {
    color: '#64748B',
    fontSize: scale(14),
    marginBottom: scale(10),
  },
  statusContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#D1FAE5',
    paddingHorizontal: scale(10),
    paddingVertical: scale(6),
    borderRadius: scale(16),
  },
  statusDot: {
    width: scale(6),
    height: scale(6),
    borderRadius: scale(3),
    backgroundColor: '#10B981',
    marginRight: scale(6),
  },
  statusText: {
    color: '#047857',
    fontSize: scale(12),
    fontWeight: '600',
  },
  section: {
    backgroundColor: '#FFFFFF',
    borderRadius: scale(12),
    padding: scale(16),
    marginBottom: scale(12),
    shadowColor: '#1E293B',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.06,
    shadowRadius: 12,
    elevation: 4,
  },
  sectionTitle: {
    fontSize: scale(16),
    fontWeight: '700',
    color: '#1E293B',
    marginBottom: scale(12),
  },
  infoRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: scale(10),
    borderBottomWidth: 1,
    borderBottomColor: '#F1F5F9',
  },
  infoLabel: {
    fontSize: scale(13),
    color: '#64748B',
    fontWeight: '500',
    flex: 1,
  },
  infoValue: {
    fontSize: scale(13),
    color: '#1E293B',
    fontWeight: '600',
    flex: 1,
    textAlign: 'right',
  },
  editButton: {
    backgroundColor: '#059669',
    borderRadius: scale(10),
    paddingVertical: scale(12),
    alignItems: 'center',
    marginBottom: scale(10),
    shadowColor: '#059669',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 4,
  },
  editButtonText: {
    color: '#FFFFFF',
    fontSize: scale(14),
    fontWeight: '700',
  },
  input: {
    flex: 1,
    borderWidth: 1,
    borderColor: '#E2E8F0',
    paddingHorizontal: 8,
    paddingVertical: 6,
    borderRadius: 8,
    textAlign: 'right',
  },
  cancelButton: {
    backgroundColor: '#FFFFFF',
    borderRadius: 12,
    paddingVertical: 14,
    alignItems: 'center',
    marginLeft: 12,
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  cancelButtonText: {
    color: '#1E293B',
    fontSize: 16,
    fontWeight: '700',
  },
  changeAvatar: {
    marginTop: 8,
    backgroundColor: '#FFFFFF',
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  changeAvatarText: {
    color: '#059669',
    fontWeight: '700',
  },
  logout: {
    backgroundColor: '#EF4444',
    borderRadius: 12,
    paddingVertical: 14,
    alignItems: 'center',
    shadowColor: '#EF4444',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 4,
  },
  logoutText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '700',
  },
});
